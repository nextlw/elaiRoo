# Plano de Implementa√ß√£o Passo a Passo: Pesquisa Profunda Nativa no Roo Code

**Baseado no Plano de Arquitetura:** [deep/deep_research_native_implementation_plan.md]

**Data:** 20 de Maio de 2025

**Vers√£o:** 1.1 (Revisado para priorizar schemas Roo existentes)

## Introdu√ß√£o

Este documento detalha os passos para implementar a funcionalidade de pesquisa profunda nativa no Roo Code, conforme o plano de arquitetura aprovado. O objetivo √© permitir que o Roo, operando em um modo especializado (`deep-research`), execute pesquisas complexas e iterativas utilizando um conjunto de novas ferramentas granulares.

## Fase 1: Configura√ß√£o do Projeto e Defini√ß√µes Base

### Subtarefa 1.1: Atualizar Schemas e Tipos Compartilhados (Priorizando Reutiliza√ß√£o)

*   **Descri√ß√£o:** Adicionar as defini√ß√µes para as novas ferramentas nos arquivos centrais de schemas, **priorizando o uso de tipos Zod e estruturas de dados j√° existentes no Roo Code**. Novos tipos espec√≠ficos s√≥ devem ser criados se n√£o houver um equivalente adequado.
*   **Arquivos a Modificar:**
    *   `src/schemas/index.ts`
*   **A√ß√µes:**
    1.  Em `src/schemas/index.ts`:
        *   Adicionar os nomes das novas ferramentas (`web_search`, `extract_page_content`, `extract_document_content`, `search_structured_data`, `search_code_repositories`, `get_repository_file_content`, e opcionalmente `process_text_content`) ao array `toolNames` e, consequentemente, ao schema `toolNamesSchema`.
        *   Para cada nova ferramenta, definir um schema Zod para seus par√¢metros (ex: `webSearchParamsSchema`). **Analisar os tipos existentes em `src/schemas/index.ts` e `src/shared` para reutiliza√ß√£o m√°xima.** Por exemplo, para caminhos de arquivo, usar `z.string()`. Para objetos de filtro gen√©ricos, `z.record(z.string(), z.any())` ou `z.string()` (para JSON stringificado) pode ser considerado, mas com documenta√ß√£o clara no prompt da ferramenta.
*   **Prompt de Delega√ß√£o para Modo Code (Exemplo para `web_search`, com foco na reutiliza√ß√£o de schema):**
    ```
    Tarefa: Atualizar schemas para nova ferramenta 'web_search', priorizando tipos Roo existentes.

    Contexto: Estamos adicionando uma nova ferramenta chamada 'web_search' ao Roo Code. √â crucial que seus par√¢metros utilizem, sempre que poss√≠vel, os tipos de schema Zod j√° definidos no projeto para manter a consist√™ncia e evitar a prolifera√ß√£o de novos tipos.

    Instru√ß√µes:
    1.  Abra o arquivo `src/schemas/index.ts`.
    2.  Adicione "web_search" ao array `toolNames` e ao schema `toolNamesSchema`.
    3.  Defina um novo schema Zod chamado `webSearchParamsSchema` para os par√¢metros da ferramenta `web_search`. Os par√¢metros s√£o:
        *   `query: string` (obrigat√≥rio) - Usar `z.string()`.
        *   `engine?: string` (opcional) - Usar `z.string().optional()`.
        *   `num_results?: number` (opcional) - Usar `z.number().optional()`.
    4.  Exporte o `webSearchParamsSchema`.
    5.  Verifique se outros tipos existentes no Roo (ex: de `ProviderSettings` para configura√ß√µes de API, ou tipos de `ToolArgs` de `src/core/prompts/tools/types.ts`) podem ser referenciados ou adaptados para os par√¢metros, em vez de criar estruturas completamente novas, especialmente se as ferramentas precisarem acessar configura√ß√µes globais.
    6.  Garanta que todas as modifica√ß√µes sigam os padr√µes de codifica√ß√£o e linting do projeto.
    ```
    *(Repetir um prompt similar para cada nova ferramenta, enfatizando a an√°lise e reutiliza√ß√£o de schemas existentes para seus par√¢metros)*

### Subtarefa 1.2: Definir Novo Grupo de Ferramentas `deepSearchTools`

*   **Descri√ß√£o:** Criar um novo grupo de ferramentas para agrupar logicamente as novas ferramentas de pesquisa profunda.
*   **Arquivo a Modificar:** `src/shared/tools.ts` (ou onde `TOOL_GROUPS` √© definido).
*   **A√ß√µes:**
    1.  Adicionar uma nova entrada ao objeto `TOOL_GROUPS`:
        ```typescript
        deepSearchTools: {
            name: "Deep Search Tools",
            tools: [
                "web_search",
                "extract_page_content",
                "extract_document_content",
                "search_structured_data",
                "search_code_repositories",
                "get_repository_file_content",
                // "process_text_content", // Se implementado
            ],
        },
        ```
*   **Prompt de Delega√ß√£o para Modo Code:**
    ```
    Tarefa: Definir novo grupo de ferramentas 'deepSearchTools'.

    Contexto: Estamos implementando uma funcionalidade de pesquisa profunda que inclui v√°rias novas ferramentas. Estas ferramentas precisam ser agrupadas.

    Instru√ß√µes:
    1.  Abra o arquivo `src/shared/tools.ts` (ou onde a constante `TOOL_GROUPS` √© definida).
    2.  Adicione uma nova entrada ao objeto `TOOL_GROUPS` com a chave `deepSearchTools`.
    3.  O valor deve ser um objeto com:
        *   `name: "Deep Search Tools"`.
        *   `tools`: um array de strings contendo os nomes das seguintes novas ferramentas: "web_search", "extract_page_content", "extract_document_content", "search_structured_data", "search_code_repositories", "get_repository_file_content". Adicione "process_text_content" se esta ferramenta for implementada.
    4.  Garanta que a formata√ß√£o e a estrutura existentes do arquivo sejam mantidas.
    ```

## Fase 2: Implementa√ß√£o das Novas Ferramentas Granulares

Para cada ferramenta listada abaixo, as seguintes etapas gerais ser√£o necess√°rias:
*   **Cria√ß√£o do Arquivo da Ferramenta:** Em `/Users/williamduarte/NCMproduto/elaiRoo/src/core/tools/` (ex: `webSearchTool.ts`).
*   **Implementa√ß√£o da L√≥gica da Ferramenta:** Seguindo o padr√£o de ferramentas existentes (ex: [`searchFilesTool.ts`](src/core/tools/searchFilesTool.ts:1)), incluindo extra√ß√£o de par√¢metros (usando os schemas definidos na Fase 1.1), l√≥gica principal, tratamento de erros, e uso de `askApproval` e `pushToolResult`. A l√≥gica interna deve utilizar utilities de `src/utils` ou servi√ßos de `src/services` sempre que poss√≠vel.
*   **Cria√ß√£o do Arquivo de Prompt da Ferramenta:** Em `/Users/williamduarte/NCMproduto/elaiRoo/src/core/prompts/tools/` (ex: `web-search.ts`).
*   **Implementa√ß√£o da Fun√ß√£o de Descri√ß√£o do Prompt:** Exportar uma fun√ß√£o `getXDescription(args: ToolArgs): string` que retorna a descri√ß√£o Markdown da ferramenta, detalhando os par√¢metros e seu uso.
*   **Registro da Ferramenta:** Adicionar a ferramenta ao `toolDescriptionMap` em `src/core/prompts/tools/index.ts`.

### Subtarefa 2.1: Implementar Ferramenta `web_search`
*   **L√≥gica Principal:**
    *   Verificar se h√° configura√ß√µes de API para motores de busca espec√≠ficos (Jina, Serper, Brave) nas `ProviderSettings` do Roo. Se sim, e a chave estiver presente, usar a API correspondente.
    *   Como fallback, ou se nenhum motor espec√≠fico for solicitado/configurado, construir uma URL de busca para um motor padr√£o (ex: Google, DuckDuckGo).
    *   Utilizar a l√≥gica existente em [`browser_action`](src/core/tools/browserActionTool.ts:1) (ou seu servi√ßo subjacente, como `BrowserSession` ou `UrlContentFetcher` de `src/services/browser/`) para abrir a URL e extrair os resultados da p√°gina (t√≠tulos, links, snippets).
    *   A extra√ß√£o de resultados da p√°gina HTML pode requerer novas utilities em `src/utils` para parsing de HTML de resultados de busca.
*   **Prompt de Delega√ß√£o para Modo Code (Implementa√ß√£o da Ferramenta `webSearchTool.ts`):**
    ```
    Tarefa: Implementar a nova ferramenta Roo 'web_search'.

    Contexto: Esta ferramenta permitir√° ao LLM realizar buscas na web e obter uma lista de resultados.

    Instru√ß√µes:
    1.  Crie o arquivo `src/core/tools/webSearchTool.ts`.
    2.  Implemente a fun√ß√£o principal da ferramenta (ex: `webSearchTool`) que recebe `cline: Task`, `block: ToolUse`, `askApproval`, etc.
    3.  Extraia os par√¢metros `query`, `engine` (opcional), `num_results` (opcional) do `block.params` usando o `webSearchParamsSchema` definido anteriormente.
    4.  L√≥gica de Execu√ß√£o:
        a.  Acesse as configura√ß√µes da API do Roo (`cline.apiConfiguration`) para verificar se h√° chaves/configura√ß√µes para os motores de busca (`engine`) especificados (ex: Jina, Serper, Brave).
        b.  Se um motor com API configurada for utiliz√°vel, fa√ßa a chamada √† API correspondente e formate os resultados (t√≠tulo, link, snippet).
        c.  Como fallback, ou se nenhum motor espec√≠fico for solicitado/configurado, construa uma URL de busca para um motor padr√£o (ex: Google).
        d.  Utilize/adapte a l√≥gica de `src/services/browser/UrlContentFetcher.ts` ou `BrowserSession.ts` para buscar a p√°gina de resultados.
        e.  Implemente ou utilize utilities em `src/utils` para fazer o parsing do HTML da p√°gina de resultados e extrair os `num_results` principais (t√≠tulos, links, snippets).
        f.  Formate os resultados como uma string ou um array de objetos.
    5.  Use `askApproval` para apresentar um resumo dos resultados encontrados antes de retorn√°-los completamente.
    6.  Use `pushToolResult` para enviar os resultados formatados.
    7.  Implemente tratamento de erros robusto.
    ```
*   **Prompt de Delega√ß√£o para Modo Code (Prompt da Ferramenta `web-search.ts`):**
    ```
    Tarefa: Criar o arquivo de prompt para a ferramenta 'web_search'.

    Contexto: A ferramenta 'web_search' foi implementada e precisa de sua descri√ß√£o para o LLM.

    Instru√ß√µes:
    1.  Crie o arquivo `src/core/prompts/tools/web-search.ts`.
    2.  Exporte uma fun√ß√£o `getWebSearchDescription(args: ToolArgs): string`.
    3.  Dentro desta fun√ß√£o, retorne uma string Markdown descrevendo a ferramenta 'web_search':
        *   Nome da ferramenta: `## web_search`
        *   Descri√ß√£o: "Realiza uma busca na web usando um motor de busca. Retorna uma lista de resultados, cada um contendo t√≠tulo, link e um breve snippet. Pode usar APIs de busca espec√≠ficas (como Jina, Serper, Brave) se configuradas pelo usu√°rio, ou recorrer a uma busca gen√©rica em motores como Google/DuckDuckGo."
        *   Par√¢metros:
            *   `query: string` (obrigat√≥rio): O termo ou pergunta da busca.
            *   `engine?: string` (opcional): O motor de busca preferido (ex: "google", "brave", "jina", "serper"). Se omitido ou n√£o configurado, um fallback ser√° usado.
            *   `num_results?: number` (opcional, default: 5): O n√∫mero m√°ximo de resultados a serem retornados.
        *   Exemplo de Uso XML.
    ```

### Subtarefa 2.2: Implementar Ferramenta `extract_page_content`
*   **L√≥gica Principal:** Usar `UrlContentFetcher` ou `BrowserSession` para obter o HTML da URL. Utilizar bibliotecas de parsing HTML (como `jsdom` ou `cheerio`, se j√° usadas no projeto, ou adicion√°-las) e algoritmos de extra√ß√£o de conte√∫do principal (ex: readability.js, ou heur√≠sticas) para limpar boilerplate.
*   *(Prompts de delega√ß√£o similares ao 2.1, adaptados para `extract_page_content`)*

### Subtarefa 2.3: Implementar Ferramenta `extract_document_content`
*   **L√≥gica Principal:** Para URLs, baixar o arquivo. Para arquivos locais, ler diretamente. Usar bibliotecas como `pdf-parse` para PDF, `mammoth` para DOCX. TXT √© leitura direta.
*   *(Prompts de delega√ß√£o similares ao 2.1, adaptados para `extract_document_content`)*

### Subtarefa 2.4: Implementar Ferramenta `search_structured_data`
*   **L√≥gica Principal:** Ler o arquivo (JSON, CSV). Para JSON/JSONL, aplicar filtros baseados em `query` e `criteria` (pode usar JSONPath ou filtragem program√°tica). Para CSV, parsear e filtrar linhas/colunas.
*   *(Prompts de delega√ß√£o similares ao 2.1, adaptados para `search_structured_data`)*

### Subtarefa 2.5: Implementar Ferramenta `search_code_repositories`
*   **L√≥gica Principal:** Interagir com a API da plataforma especificada (inicialmente GitHub). Requer gerenciamento de chaves de API (ver Fase 5).
*   *(Prompts de delega√ß√£o similares ao 2.1, adaptados para `search_code_repositories`)*

### Subtarefa 2.6: Implementar Ferramenta `get_repository_file_content`
*   **L√≥gica Principal:** Interagir com a API da plataforma para buscar o conte√∫do do arquivo. Requer gerenciamento de chaves de API.
*   *(Prompts de delega√ß√£o similares ao 2.1, adaptados para `get_repository_file_content`)*

### Subtarefa 2.7: (Opcional) Implementar Ferramenta `process_text_content`
*   **L√≥gica Principal:** Implementar fun√ß√µes para cada `operation` (ex: `fixMarkdown`, `removeDuplicateLines`) em `src/utils/text_processing_utils.ts` e cham√°-las com base no par√¢metro.
*   *(Prompts de delega√ß√£o similares ao 2.1, adaptados para `process_text_content`)*

## Fase 3: Implementa√ß√£o do Novo Modo `deep-research`

### Subtarefa 3.1: Configurar o Modo `deep-research`
*   **Descri√ß√£o:** Adicionar a defini√ß√£o formal do modo ao sistema Roo.
*   **Arquivo a Modificar:** `src/shared/modes.ts`.
*   **A√ß√µes:**
    1.  Adicionar um novo objeto √† lista de modos:
        ```typescript
        {
            slug: "deep-research",
            name: "üî¨ Deep Research",
            roleDefinition: "Voc√™ √© Roo, um especialista em conduzir pesquisas profundas e exaustivas...", // Completo conforme plano de arquitetura
            whenToUse: "Quando o usu√°rio solicitar uma pesquisa complexa que envolva coleta, an√°lise e s√≠ntese de informa√ß√µes de m√∫ltiplas fontes de forma iterativa (ex: pesquisa de NCM, an√°lise de reposit√≥rios, investiga√ß√£o t√©cnica).",
            groups: [
                "deepSearchTools", // O novo grupo
                "read",
                "browser",
                "ask",
                "completion",
                // "edit", // Se for salvar relat√≥rios
            ],
            customInstructions: "Voc√™ seguir√° um processo metodol√≥gico de pesquisa...", // Placeholder, o prompt principal vir√° abaixo
        }
        ```
*   **Prompt de Delega√ß√£o para Modo Code:**
    ```
    Tarefa: Configurar o novo modo 'deep-research'.

    Contexto: Estamos adicionando um modo especializado para pesquisa profunda.

    Instru√ß√µes:
    1.  Abra o arquivo `src/shared/modes.ts`.
    2.  Adicione um novo objeto de configura√ß√£o de modo √† lista de modos com os seguintes campos:
        *   `slug: "deep-research"`
        *   `name: "üî¨ Deep Research"`
        *   `roleDefinition: "Voc√™ √© Roo, um especialista em conduzir pesquisas profundas e exaustivas. Sua miss√£o √© seguir um processo metodol√≥gico para encontrar, analisar e sintetizar informa√ß√µes de diversas fontes para responder √† solicita√ß√£o do usu√°rio."`
        *   `whenToUse: "Quando o usu√°rio solicitar uma pesquisa complexa que envolva coleta, an√°lise e s√≠ntese de informa√ß√µes de m√∫ltiplas fontes de forma iterativa (ex: pesquisa de NCM, an√°lise de reposit√≥rios, investiga√ß√£o t√©cnica)."`
        *   `groups: ["deepSearchTools", "read", "browser", "ask", "completion"]` (adicione "edit" se a escrita de arquivos for permitida neste modo).
        *   `customInstructions: "O prompt detalhado para este modo ser√° fornecido separadamente e gerenciado pelo sistema de prompts. Este campo pode conter instru√ß√µes de alto n√≠vel ou ser deixado para o prompt principal."`
    ```

### Subtarefa 3.2: Desenvolver o Prompt de Sistema Detalhado para o Modo `deep-research`
*   **Descri√ß√£o:** Criar o conte√∫do do prompt de sistema que guiar√° o LLM. Este √© o "agente".
*   **Local:** Este prompt pode ser um arquivo `.md` dedicado em `src/core/prompts/modes/deep-research.md` e carregado dinamicamente, ou uma string longa em `src/shared/modes.ts` (na propriedade `customInstructions` do modo, ou referenciado por ela). A abordagem de arquivo `.md` √© mais manuten√≠vel.
*   **Conte√∫do:** Conforme detalhado na Se√ß√£o 2.3 do plano de arquitetura (`deep_research_native_implementation_plan.md`), cobrindo as fases de An√°lise, Planejamento, Coleta Iterativa, An√°lise/S√≠ntese, Refinamento/Itera√ß√£o, Relat√≥rio e Apresenta√ß√£o, com √™nfase no uso das ferramentas Roo e na documenta√ß√£o do "thinking".
*   **Prompt de Delega√ß√£o para Modo Code (para criar o arquivo de prompt):**
    ```
    Tarefa: Criar o arquivo de prompt de sistema para o modo 'deep-research'.

    Contexto: O modo 'deep-research' precisa de um prompt de sistema detalhado que atue como o "agente" de pesquisa, guiando o LLM.

    Instru√ß√µes:
    1.  Crie um novo arquivo: `src/core/prompts/modes/deep-research.md`.
    2.  Preencha este arquivo com o seguinte conte√∫do Markdown, que define o workflow de pesquisa profunda para o LLM (adaptar e expandir conforme necess√°rio):

        ```markdown
        Voc√™ √© Roo, operando no modo "Pesquisa Profunda". Sua miss√£o √© executar pesquisas complexas e exaustivas para responder √† solicita√ß√£o do usu√°rio. Siga rigorosamente o processo abaixo:

        **PROCESSO DE PESQUISA PROFUNDA ITERATIVA:**

        **Fase 1: An√°lise e Decomposi√ß√£o da Solicita√ß√£o**
        1.  **Entenda o Objetivo:** Qual √© a pergunta principal que o usu√°rio quer responder? Quais s√£o os entreg√°veis esperados?
        2.  **Identifique Entidades Chave:** Quais s√£o os principais termos, conceitos, produtos, tecnologias, etc., mencionados?
        3.  **Determine o Escopo:** A pesquisa √© ampla ou focada? Existem restri√ß√µes (ex: per√≠odo de tempo, fontes espec√≠ficas)?
        4.  **Formule Sub-Perguntas:** Se a solicita√ß√£o for complexa, divida-a em perguntas menores e mais gerenci√°veis.

        **Fase 2: Planejamento Inicial da Pesquisa**
        1.  **Identifique Tipos de Fontes:** Onde a informa√ß√£o provavelmente reside? (Ex: Documenta√ß√£o oficial, artigos t√©cnicos, reposit√≥rios de c√≥digo, bases de dados internas, f√≥runs, not√≠cias).
        2.  **Selecione Ferramentas Iniciais:** Com base nos tipos de fontes, quais ferramentas Roo s√£o mais apropriadas para come√ßar? (Ex: `web_search` para uma vis√£o geral, `search_code_repositories` se for sobre c√≥digo, `search_structured_data` para dados internos).
        3.  **Formule Consultas Iniciais:** Crie as primeiras consultas para as ferramentas selecionadas.

        **Fase 3: Coleta Iterativa e An√°lise de Dados**
        *   **PARA CADA ETAPA DE COLETA:**
            1.  **Execute a Ferramenta:** Chame a ferramenta Roo selecionada com a consulta apropriada. Exemplo: `<web_search><query>...</query></web_search>`.
            2.  **Analise o Resultado:**
                *   O resultado √© relevante para a pergunta/sub-pergunta atual?
                *   A informa√ß√£o √© suficiente? √â de uma fonte confi√°vel?
                *   O resultado abre novas linhas de investiga√ß√£o ou sugere outras fontes/ferramentas?
            3.  **Extraia Informa√ß√£o Chave:** Copie e guarde os trechos mais importantes do resultado.
            4.  **Refine ou Expanda:**
                *   Se o resultado for muito amplo, refine sua consulta e tente novamente com a mesma ferramenta ou uma mais espec√≠fica.
                *   Se o resultado for muito limitado, amplie sua consulta ou tente uma ferramenta diferente.
                *   Se encontrar URLs para documentos ou p√°ginas relevantes, use `extract_page_content` ou `extract_document_content`.
                *   Se encontrar reposit√≥rios, use `get_repository_file_content` para explorar arquivos espec√≠ficos.
            5.  **Necessidade de Esclarecimento:** Se voc√™ encontrar ambiguidades, ou se precisar de mais contexto do usu√°rio para prosseguir ou refinar o escopo, use a ferramenta `
